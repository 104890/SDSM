# InterVlan Routing

## InterVlan Routing

Чуточку практики для взбадривания.  
В [предыдущий](https://linkmeup.gitbook.io/sdsm/2.-switching) раз мы настроили коммутаторы нашей локальной сети. На данный момент устройства разных вланов не видят друг друга. То есть фактически ФЭО и ПТО, например, находятся в совершенно разных сетях и не связаны друг с другом. Так же и серверная сеть существует сама по себе. Надо бы исправить эту досадную неприятность.  
В нашей московской сети для маршрутизации между вланами мы будем использовать роутер cisco 2811. Иными словами он будет терминировать вланы. Кадры здесь заканчивают свою жизнь: из них извлекаются IP-пакеты, а заголовки канального уровня отбрасываются.

![](http://img-fotki.yandex.ru/get/5904/83739833.16/0_83196_8c1055b6_XL.jpg)

Процесс настройки маршрутизатора очень прост:

0\) Сначала закончим с коммутатором msk-arbat-dsw1. На нём нам нужно настроить транковый порт в сторону маршрутизатора, чего мы не сделали в прошлый раз.

```text
msk-arbat-dsw1(config)#interface FastEthernet0/24
msk-arbat-dsw1(config-if)# description msk-arbat-gw1
msk-arbat-dsw1(config-if)# switchport trunk allowed vlan 2-3,101-104
msk-arbat-dsw1(config-if)# switchport mode trunk
```

1\) Назначаем имя маршрутизатора командой **hostname**, а для развития хорошего тона, надо упомянуть, что лучше сразу же настроить время на устройстве. Это поможет вам корректно идентифицировать записи в логах.

```text
Router0#clock set 12:34:56 7 august 2012
Router0# conf t
Router0(config)#hostname msk-arbat-gw1
```

Желательно время на сетевые устройства раздавать через [NTP](http://ru.wikipedia.org/wiki/Ntp) \(любую циску можно сделать NTP-сервером, кстати\)

2\) Далее переходим в режим настройки интерфейса, обращённого в нашу локальную сеть и включаем его, так как по умолчанию он находится в состоянии Administratively down.

```text
msk-arbat-gw1(config)#interface fastEthernet 0/0
msk-arbat-gw1(config-if)#no shutdown
```

3\) Создадим виртуальный интерфейс или иначе его называют подинтерфейс или ещё сабинтерфейс \(sub-interface\).

```text
msk-arbat-gw1(config)#interface fa0/0.2
msk-arbat-gw1(config-if)#description Management
```

Логика тут простая. Сначала указываем обычным образом физический интерфейс, к которому подключена нужная сеть, а после точки ставим некий уникальный идентификатор этого виртуального интерфейса. Для удобства, обычно номер сабинтерфейса делают аналогичным влану, который он терминирует.

4\) Теперь вспомним о стандарте [802.1q](http://xgu.ru/wiki/802.1Q), который описывает тегирование кадра меткой влана. Следующей командой вы обозначаете, что кадры, исходящие из этого виртуального интерфейса будут помечены тегом 2-го влана. А кадры, входящие на физический интерфейс FastEthernet0/0 с тегом этого влана будут приняты виртуальным интерфейсом FastEthernet0/0.2.

```text
msk-arbat-gw1(config-if)#encapsulation dot1Q 2
```

5\) Ну и как на обычном физическом L3-интерфейсе, определим IP-адрес. Этот адрес будет шлюзом по умолчанию \(default gateway\) для всех устройств в этом влане.

```text
msk-arbat-gw1(config-if)#ip address 172.16.1.1 255.255.255.0
```

Аналогичным образом настроим, например, 101-й влан:

```text
msk-arbat-gw1(config)#interface FastEthernet0/0.101
msk-arbat-gw1(config-if)#description PTO
msk-arbat-gw1(config-if)#encapsulation dot1Q 101
msk-arbat-gw1(config-if)#ip address 172.16.3.1 255.255.255.0
```

и теперь убедимся, что с компьютера из сети ПТО мы видим сеть управления:  
![](http://img-fotki.yandex.ru/get/6101/83739833.14/0_81a6b_f5e01ab7_XL.jpg)

Работает и отлично, настройте пока все остальные интерфейсы. Проблем с этим возникнуть не должно.

### Физика и логика процесса межвланной маршрутизации

Что происходит в это время с вашими данными? Мы рассуждали в [прошлый раз](https://linkmeup.ru/blog/13.html), что происходит, если вы пытаетесь связаться с устройством из той же самой подсети, в которой находитесь вы. Под той же самой подсетью мы понимаем следующее: например, на вашем компьютере настроено следующее:  
IP: 172.16.3.2  
Mask: 255.255.255.0  
GW: 172.16.3.1

Все устройства, адреса которых будут находиться в диапазоне 172.16.3.1-172.16.3.254 с такой же маской, как у вас, будут являться членами вашей подсети. Что происходит с данными, если вы отправляете их на устройство с адресом из этого диапазона? Повторим это с некоторыми дополнениями.

Для отправки данных они должны быть упакованы в Ethernet-кадр, в заголовок которого должен быть вставлен MAC-адрес удалённого устройства. Но откуда его взять?  
Для этого ваш компьютер рассылает широковещательный ARP-запрос. В качестве IP-адреса узла назначения в IP-пакет с этим запросом будет помещён адрес искомого хоста. Сетевая карта при инкапсуляции указывает MAC-адрес FF:FF:FF:FF:FF:FF — это значит, что кадр предназначен всем устройствам. Далее он уходит на ближайший коммутатор и копии рассылаются на все порты нашего влана \(ну, кроме, конечно, порта, из которого получен кадр\). Получатели видят, что запрос широковещательный и они могут оказаться искомым хостом, поэтому извлекают данные из кадра. Все те устройства, которые не обладают указанным в ARP-запросе IP-адресом, просто игнорируют запрос, а вот устройство-настоящий получатель ответит на него и вышлет первоначальному отправителю свой MAC-адрес. Отправитель \(в данном случае, наш компьютер\) помещает полученный MAC в свою таблицу соответствия IP и MAC адресов ака ARP-кэш. Как выглядит ARP-кэш на вашем компьютере прямо сейчас, вы можете посмотреть с помощью команды **arp -a**  
![](http://img-fotki.yandex.ru/get/6105/83739833.16/0_838ff_c9405fb3_XL.jpg)

Потом ваши полезные данные упаковываются в IP-пакет, где в качестве получателя ставится тот адрес, который вы указали в команде/приложении, затем в Ethernet-кадр, в заголовок которого помещается полученный ARP-запросом MAC-адрес. Далее кадр отправляется на коммутатор, который, согласно своей таблице MAC-адресов, решает, в какой порт его переправить дальше.

Но что происходит, если вы пытаетесь достучаться до устройства в другом влане? ARP-запрос ничего не вернёт, потому что широковещательные L2 сообщения кончаются на маршрутизаторе\(т.е., в пределах широковещательного L2 домена\), нужная сеть находится за ним, а коммутатор не пустит кадры из одного влана в порт другого. И вот для этого нужен шлюз по умолчанию \(default gateway\) на вашем компьютере. То есть, если устройство-получатель в вашей же подсети, кадр просто отправляется в порт с мак-адресом конечного получателя. Если же сообщение адресовано в любую другую подсеть, то кадр отправляется на шлюз по умолчанию, поэтому в качестве MAC-адреса получателя подставится MAC-адрес маршрутизатора.

Проследим за ходом событий.

1\) ПК с адресом 172.16.3.2/24 хочет отправить данные компьютеру с адресом 172.16.4.5.  
![](http://img-fotki.yandex.ru/get/6101/83739833.14/0_81ada_d08b99b3_XL.jpg)  
Он видит, что адрес из другой подсети, следовательно, данные должны уйти на шлюз по умолчанию. Но в таком случае, ПК нужен MAC-адрес шлюза. ПК проверяет свой ARP-кэш в поисках соответствия IP-адрес шлюза — MAC-адрес и не находит нужного  
![](http://img-fotki.yandex.ru/get/6100/83739833.14/0_81adb_3ffbe426_XL.jpg)

2\) ПК отправляет широковещательный ARP-запрос в локальную сеть. Структура ARP-запроса:  
— на канальном уровне в качестве получателя — широковещательный адрес \( FF:FF:FF:FF:FF:FF\), в качестве отправителя — MAC-адрес интерфейса устройства, пытающегося выяснить IP  
— на сетевом — собственно ARP запрос, в нем содержится информация о том, какой IP и кем ищется.  
![](http://img-fotki.yandex.ru/get/5908/83739833.16/0_83900_cf328214_XL.jpg)

3\) Коммутатор, на который попал кадр, рассылает его копии во все порты этого влана \(того, которому принадлежит изначальный хост\), кроме того, откуда он получен.  
4\) Все устройства, получив этот кадр и, видя, что он широковещательный, предполагают, что он адресован им.  
5\) Распаковав кадр, все хосты, кроме маршрутизатора, видят, что в ARP-запросе не их адрес. А маршрутизатор посылает [unicast’овый](http://eucariot.livejournal.com/62043.html) ARP-ответ со своим MAC-адресом.  
6\) Изначальный хост получает ARP-ответ, теперь у него есть MAC-адрес шлюза. Он формирует пакет из тех данных, что ему нужно отправить на 172.16.4.5. **В качестве** _**MAC-адреса**_ **получателя ПК ставит адрес шлюза. При этом** _**IP-адрес**_ **получателя в пакете остаётся 172.16.4.5**  
![](http://img-fotki.yandex.ru/get/5607/83739833.14/0_81adc_2601877a_XL.jpg)

7\) Кадр посылается в сеть, коммутаторы доставляют его на маршрутизатор.  
8\) На маршрутизаторе, в соответствии с меткой влана, кадр принимается конкретным сабинтерфейсом. **Данные канального уровня откидываются**.  
9\) Из заголовка IP-пакета, рутер узнаёт адрес получателя, а из своей таблицы маршрутизации видит, что тот находится в непосредственно подключенной к нему сети на определённом сабинтерфейсе \(в нашем случае FE0/0.102\).

```text
C 172.16.0.0/24 is directly connected, FastEthernet0/0.3
C 172.16.1.0/24 is directly connected, FastEthernet0/0.2
C 172.16.2.16/30 is directly connected, FastEthernet0/1.5
C 172.16.3.0/24 is directly connected, FastEthernet0/0.101
C 172.16.4.0/24 is directly connected, FastEthernet0/0.102
C 172.16.5.0/24 is directly connected, FastEthernet0/0.103
C 172.16.6.0/24 is directly connected, FastEthernet0/0.104
```

10\) Маршрутизатор отправляет ARP-запрос с этого сабинтерфейса — узнаёт MAC-адрес получателя.  
11\) Изначальный IP-пакет, не **изменяясь** инкапсулируется в **новый кадр**, при этом:

* в качестве MAC-адреса источника указывается адрес интерфейса шлюза
* IP-адрес источника — адрес изначального хоста \(в нашем случае 172.16.3.2\)
* в качестве MAC-адреса получателя указывается адрес конечного хоста
* IP-адрес получателя — адрес конечного хоста \(в нашем случае 172.16.4.5\)

и отправляется в сеть с сабинтерфейса FastEthernet0/0.102, получая при этом метку 102-го влана.

12\) Кадр доставляется коммутаторами до хоста-получателя.

## Планирование расширения

Теперь обратимся к планированию. В нулевой части мы уже затронули эту тему, но тогда речь была только о двух офисах в Москве, теперь же сеть растёт.

Будет она вот такой:  
![](http://img-fotki.yandex.ru/get/6204/83739833.16/0_83901_7a5483b7_XL.jpg)

То есть прибавляются две точки в Санкт-Петербурге: небольшой офис на Васильевском острове и сам завод в Озерках — и одна в Кемерово в районе Красная горка. Для простоты у нас будет один провайдер “Балаган Телеком”, который на выгодных условиях предоставит нам L2VPN до обеих точек. В одном из следующих выпусков мы тему различных вариантов подключения раскроем в красках. А пока вкратце: L2VPN — это, очень грубо говоря, когда вам провайдер предоставляет влан от точки до точки \(можно для простоты представить, что они включены в один коммутатор\).

Следует сказать несколько слов об IP-адресации и делении на подсети. В нулевой части мы уже затронули вопросы планирования, весьма вскользь, надо сказать. Вообще, в любой более или менее большой компании должен быть некий регламент — свод правил, следуя которому вы распределяете IP-адреса везде. Сеть у нас сейчас разрастается и разработать его очень важно.

Ну вот к примеру, скажем, что для офисов в других городах это будет так:  
![](http://img-fotki.yandex.ru/get/6202/83739833.16/0_82fef_6bef2d18_L.jpg)

Это весьма упрощённый регламент, но теперь мы во всяком случае точно знаем, что у шлюза всегда будет 1-й адрес, до 12-го мы будем выдавать коммутаторам и всяким wi-fi-точкам, а все сервера будем искать в диапазоне 172.16.х.13-172.16.х.23. Разумеется, по своему вкусу вы можете уточнять регламент вплоть до адреса каждого сервера, добавлять в него правило формирования имён устройств, доменных имён, политику списков доступа и т.д. Чем точнее вы сформулируете правила и строже будете следить за их выполнением, тем проще разбираться в структуре сети, решать проблемы, адаптироваться к ситуации и наказывать виновных. Это примерно, как схема запоминания паролей: когда у вас есть некое правило их формирования, вам не нужно держать в голове несколько десятков сложнозапоминаемых паролей, вы всегда можете их вычислить. Вот так же и тут. Я некогда работал в средних размеров холдинге и знал, что если я приеду в офис где-нибудь в забытой коровами деревне, то там точно x.y.z.1 — это циска, x.y.z.2 — дистрибьюшн-свитч прокурва, а x.y.z.101 — компьютер главного бухгалтера, с которого надо дать доступ на какой-нибудь контур-экстерн. Другой вопрос, что надо это ещё проверить, потому что местные ИТшники такого порой наворотят, что слезами омываешься сквозь смех.

> Было дело парнишка решил сам управлять всем доступом в интернет \(обычно это делал я на маршрутизаторе\). Поставил proxy-сервер, случайно поднял на нём NAT и зарулил туда трафик локальной сети, на всех машинах прописав его в качестве шлюза по умолчанию, а потом я минут 20 разбирался, как так: у них всё работает, а мы их не видим.

### IP-план

Теперь нам было бы весьма кстати составить IP-план. Будем исходить из того, что на всех трёх точках мы будем использовать стандартную сеть с маской 24 бита \(255.255.255.0\) Это означает, что в них может быть 254 устройства.

Почему это так? И как вообще понять все эти маски подсетей? В рамках одной статьи мы не сможем этого рассказать, иначе она получится длинная, как палуба Титаника и запутанная, как одесские катакомбы. Крайне рекомендуем очень плотно познакомиться с такими понятиями, как IP-адрес, маска подсети, их представления в двоичном виде и CIDR \(Classless InterDomain Routing\) самостоятельно. Мы же далее будем только аргументировать выбор конкретного размера сети. Как бы то ни было, полное понимание придёт только с практикой.  
Вообще, очень неплохо эта тема раскрыта в этой статье: [http://habrahabr.ru/post/129664/](http://habrahabr.ru/post/129664/)

В данный момент \(вспомним [нулевой выпуск](https://linkmeup.ru/blog/11.html)\) у нас в Москве использованы адреса 172.16.0.0-172.16.6.255. Предположим, что сеть может ещё увеличиться здесь, допустим, появится офис на Воробьёвых горах и зарезервируем ещё подсети до 172.16.15.0/24 включительно.  
Все эти адреса: 172.16.0.0-172.16.15.255 — можно описать так: 172.16.0.0/20. Эта сеть \(с префиксом /20\) будет так называемой _суперсетью_, а операция объединения подсетей в суперсети называется _суммированием_ подсетей \(суммированием маршрутов, если быть точным, route summarization\)

Очень наглядный [IP-калькулятор](http://www.ispreview.ru/ipcalc.html). Я и сейчас им периодически пользуюсь, хотя со временем приходит интуитивное и логическое понимание соответствия между длиной маски и границами сети.

Теперь обратимся к Питеру. В данный момент в этом прекрасном городе у нас 2 точки и на каждой из них подсети /24. Допустим это будут 172.16.16.0/24 и 172.16.17.0/24. Зарезервируем адреса 172.16.18.0-172.16.23.255 для возможного расширения сети.

172.16.16.0-172.16.23.255 можно объединить в 172.16.16.0/21 — в общем-то исходя именно из этого мы и оставляем в резерв именно такой диапазон.

В Кемерово нам нет смысла оставлять такие огромные запасы /21, как в Питере \(2048 адресов или 8 подсетей /24\), или тем более /20, как в Москве \(4096 или 16 подсетей /24\). А вот 1024 адреса и 4 подсети /24, которым соответствует маска /22 вполне рационально.

Таким образом сеть 172.16.24.0/22 \(адреса 172.16.24.0-172.16.27.255\) будет у нас для Кемерово.

![](http://img-fotki.yandex.ru/get/6103/83739833.16/0_82ff0_2c5ff40_L.jpg)

Тут надо бы заметить: делать такой запас в общем-то необязательно и то, что мы зарезервировали вполне можно использовать в любом другом месте сети. Нет табу на этот счёт. Однако в крупных сетях именно так и рекомендуется делать и связано это с количеством информации в таблицах маршрутизации.  
Понимаете ли дело вот в чём: если у вас несколько подряд идущих подсетей разбросаны по разным концам сети, то каждой из них соответствует одна запись в таблице маршрутизации каждого маршрутизатора. Если при этом вы вдруг используете только статическую маршрутизацию, то это ещё колоссальный труд по настройке и отслеживанию корректности настройки.  
А если же они у вас все идут подряд, то несколько маленьких подсетей вы можете суммировать в одну большую.  
Поясним на примере Санкт-Петербурга. При настройке статической маршрутизации мы могли бы делать так:

```text
ip route 172.16.16.0 255.255.255.0 172.16.2.2
ip route 172.16.17.0 255.255.255.0 172.16.2.2
ip route 172.16.18.0 255.255.255.0 172.16.2.2
……
ip route 172.16.23.0 255.255.255.0 172.16.2.2
```

Это 8 команд и 8 записей в таблице. Но при этом пришедший на маршрутизатор пакет в любую из сетей 172.16.16.0/21 в любом случае будет отправлен на устройство с адресом 172.16.2.2.  
Вместо этого мы поступим так:

```text
ip route 172.16.16.0 255.255.248.0 172.16.2.2
```

И вместо восьми возможных сравнений будет только одно.  
Для современных устройств ни в плане процессорного времени ни использования памяти это уже не является существенной нагрузкой, однако такое планирование считается правилами хорошего тона и в конечном итоге вам же самим проще разобраться. Положа руку на сердце, такое планирование скорее исключение, нежели правило: так или иначе фрагментация маршрутов с ростом сети неизбежна.

Теперь ещё несколько слов о _линковых_ сетях. В среде сетевых администраторов так называются сети точка-точка \(Point-to-Point\) между двумя маршрутизаторами.  
Вот опять же в примере с Питером. Два маршрутизатора \(в Москве и в Петербурге\) соединены друг с другом прямым линком \(неважно, что у провайдера это сотня коммутаторов и маршрутизаторов — для нас это просто влан\). То есть кроме вот этих 2-х устройств здесь не будет никаких других. Мы знаем это наверняка. В любом случае на интерфейсах обоих устройств \(смотрящих в сторону друг друга\) нужно настраивать IP-адреса. И нам точно незачем назначать на этом участке сеть /24 с 254 доступными адресами, ведь 252 в таком случае пропадут почём зря. В этом случае есть прекрасный выход — бесклассовая IP-адресация.

Почему она бесклассовая? Если вы помните, то в нулевой части мы говорили о трёх классах подсетей: А, В и С. По идее только их вы и могли использовать при планировании сети. Бесклассовая междоменная маршрутизация \([CIDR](http://mannix.ru/poleznoe/besklassovaya-adresaciya-cidr.html)\) позволяет очень гибко использовать пространство IP-адресов.

Мы просто берём сеть с самой маленькой возможной маской — 30 \(255.255.255.252\) — это сеть на 4 адреса. Почему мы не можем взять сеть с ещё более узкой маской? Ну 32 \(255.255.255.255\) по понятными причинам — это вообще один единственный адрес, сеть 31 \(255.255.255.254\) — это уже 2 адреса, но один из них \(первый\) — это адрес сети, а второй \(последний\) — широковещательный. В итоге на адреса хостов у нас и не осталось ничего. Поэтому и берём маску 30 с 4 адресами и тогда как раз 2 адреса остаются на наши два маршрутизатора.

Вообще говоря, самой узкой маской для подсетей в cisco таки является /31. При определённых условиях их можно использовать на P-t-P-линках.  
Что же касается маски /32, то такие подсети, которые суть один единственный хост, используются для назначения адресов Loopback-интерфейсам.

Именно так мы и поступим. Для этого, собственно, в нулевой части мы и оставили сеть 172.16.2.0/24 — её мы будем дробить на мелкие сетки /30. Всего их получится 64 штуки, соответственно можно назначить их на 64 _линка_.

![](http://img-fotki.yandex.ru/get/6202/83739833.16/0_82ffd_7d77a589_XL.jpg)

Здесь мы поступили так же, как и в предыдущем случае: сделали небольшой резерв для Питера, и резерв для Кемерово. Вообще резерв — это всегда очень хорошо о чём бы мы ни говорили. ;\)

