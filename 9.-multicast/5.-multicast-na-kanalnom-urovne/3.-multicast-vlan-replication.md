# Multicast VLAN Replication

Сокращённо **MVR**. Это механизм для тех провайдеров, кто практикует [VLAN-per-user](http://lookmeup.linkmeup.ru/#term230), например.  
Вот типичный пример сети, где MVR жизненно необходим:

![MVR](http://img-fotki.yandex.ru/get/9820/83739833.38/0_da33e_e680062a_XL.png)

5 клиентов в разных VLAN'ах, и все хотят получать мультикастовый трафик одной группы 224.2.2.4. При этом клиенты должны оставаться изолированными друг от друга.

IGMP Snooping учитывает, разумеется и VLAN'ы. Если пять клиентов в разных VLAN'ах запрашивают одну группу — это будет пять разных таблиц. Соответственно и к маршрутизатору идут 5 запросов на подключение к группе. И каждый сабинтерфейс из этих пяти на маршрутизаторе будет добавлен отдельно в OIL. То есть получив 1 поток для группы 224.2.2.4 он отправит 5 копий, несмотря на то, что все они идут в один сегмент.

![Multicast VLAN Replication](http://img-fotki.yandex.ru/get/6729/83739833.38/0_da33f_932558b_XL.png)

Для решения этой проблемы и был разработан механизм Multicast VLAN Replication.  
Вводится дополнительный VLAN — **Multicast VLAN** — в нём, соответственно, будет передаваться мультикастовый поток. Он «проброшен» непосредственно до последнего коммутатора, где трафик из него копируется во все клиентские интерфейсы, которые хотят получать этот трафик — это и есть репликация.  
В зависимости от реализации репликация из Multicast VLAN может производиться в **User-VLAN** или в определённые физические интерфейсы.

![Multicast VLAN Replication](http://img-fotki.yandex.ru/get/9812/83739833.38/0_da35b_95f170a3_XL.png)  
А что с IGMP-сообщениями? Query от маршрутизатора, естественно, приходит по мультикастовому VLAN'у. Коммутатор их рассылает в клиентские порты. Когда Report или Leave приходит от клиента, коммутатор проверяет откуда именно \(VLAN, интерфейс\) и, если необходимо, перенаправляет в мультикастовый VLAN.  
Таким образом обычный трафик изолирован и по-прежнему ходит до маршрутизатора в пользовательском VLAN'е. А мультикастовый трафик и IGMP-пакеты передаются в Multicast VLAN.

> На оборудовании Cisco MVR и IGMP Snooping настраиваются независимо. То есть можно отключить один и второй будет работать. Вообще же MVR основан на IGMP Snooping и на коммутаторах других производителей для работы MVR может быть обязательным включение IGMP Snooping.

Кроме того, IGMP Snooping позволяет осуществлять на коммутаторах фильтрацию трафика, ограничивать количество групп, доступных пользователю, включение IGMP Querier, статическую настройку восходящих портов, перманентное подключение к какой-либо группе \(этот сценарий есть в сопутствующем [видео](http://www.youtube.com/watch?feature=player_embedded&v=7MqBF0wKNR0#t=60)\), быструю реакцию на изменение топологии путём рассылки дополнительных Query, SSM-Mapping для IGMPv2 итд.

Заканчивая разговор об IGMP Snooping, хочется повторить — это необязательный функционал — всё и без него будет работать. Но это сделает сеть более предсказуемой, а жизнь инженера спокойнее.  
Однако все плюсы IGMP Snooping можно обернуть и против себя. Один такой выдающийся случай можно почитать по [ссылке](http://nag.ru/articles/article/25136/takie-raznyie-problemyi.html).  
К слову у той же Cisco есть протокол [CGMP](http://lookmeup.linkmeup.ru/#term352) — аналог IGMP, который не нарушает принципы работы коммутатора, но он проприетарный и не сказать, что широко распространённый.

Итак, мой неутомимый читатель, мы приближаемся к концу выпуска и напоследок хочется показать, как может быть реализована услуга IPTV на стороне клиента.  
Самый простой способ, к которому мы уже не раз обращались в этой статье — запустить плеер, который может принять мультикастовый поток из сети. На нём можно вручную задать IP-адрес группы и наслаждаться видео.  
Другой программный вариант, который часто используют провайдеры — специальное приложение, обычно весьма кастомное, в котором зашит набор каналов, используемых в сети провайдера. Нет необходимости что-то задавать вручную — нужно просто переключать каналы кнопками.

Оба эти способа дают возможность смотреть потоковое видео только на компьютере.

Третий же вариант позволяет использовать телевизор, причём как правило, любой. Для этого в доме клиента ставит так называемый Set-Top-Box \(STB\) — коробочка, устанавливаемая на телевизор. Это шелезяка, которая включается в абонентскую линию и разделяет трафик: обычный юникаст она отдаёт в Ethernet или WiFi, чтобы клиенты имели доступ в Интернет, а мультикастовый поток передаётся на телевизор через кабель \(DVI, RGB, антенный итд.\).  
Часто вы, кстати, можете увидеть рекламу, где провайдер предлагает свои приставки для подключения телевидения — это и есть те самые STB

Незатронутыми в статье остались междоменная маршрутизация мультикастового трафика \([MSDP](http://lookmeup.linkmeup.ru/#term349), [MBGP](http://lookmeup.linkmeup.ru/#term238), [BGMP](http://lookmeup.linkmeup.ru/#term237)\), балансировка нагрузки между RP \([Anycast RP](http://lookmeup.linkmeup.ru/#term314)\), [PGM](http://habrahabr.ru/post/148444/), проприетарные протоколы. Но, я думаю, имея как точку старта эту статью, разобраться в остальном не составит труда.  
Все термины, касающиеся мультикаста, вы можете найти в телекоммуникационном глоссарии [lookmeup](http://lookmeup.linkmeup.ru/).  
За помощь в подготовке статьи спасибо [JDima](http://habrahabr.ru/users/jdima/).  
За техническую поддержку спасибо [Наташе Самойленко](http://xgu.ru/wiki/Категория:Автор_Наташа_Самойленко).

КДПВ нарисована [Ниной Долгополовой](http://www.nina-dolgopolova.com/) — замечательным художником и другом проекта.

В пуле статей СДСМ ещё много интересного до окончания, поэтому не нужно хоронить цикл из-за долгого отсутствия выпуска — с каждой новой статьёй сложность значительно возрастает. Впереди почти весь MPLS, IPv6, QoS и дизайн сетей.

