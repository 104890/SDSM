# Работа ACL в картинках

Гипотетическая сеть:

![](http://img-fotki.yandex.ru/get/6405/83739833.1b/0_92a17_54168b47_XL.jpg)

1\) На маршрутизаторе RT1 на интерфейсе FE0/1 на вход у нас разрешено всё, кроме ICMP.

![](http://img-fotki.yandex.ru/get/5706/83739833.1b/0_92a18_3887c542_XL.jpg)

2\) На маршрутизаторе RT2 на интерфейсе FE0/1 на выход запрещены SSH и TELNET

![](http://img-fotki.yandex.ru/get/6403/83739833.1b/0_92a19_fca28647_XL.jpg)

Тесты  
_кликабельны_  
1\) Пинг с компьютера ПК1 на Сервер1  
[![](http://img-fotki.yandex.ru/get/6403/83739833.1b/0_92a13_e88a2c24_M.jpg)](http://img-fotki.yandex.ru/get/6403/83739833.1b/0_92a13_e88a2c24_L.jpg)  
2\) TELNET с компьютера ПК1 на Сервер1  
[![](http://img-fotki.yandex.ru/get/6404/83739833.1b/0_92a14_fcf521de_M.jpg)](http://img-fotki.yandex.ru/get/6404/83739833.1b/0_92a14_fcf521de_L.jpg)  
3\) SSH с компьютера ПК1 на Сервер2  
[![](http://img-fotki.yandex.ru/get/6401/83739833.1b/0_92a15_f45836_M.jpg)](http://img-fotki.yandex.ru/get/6401/83739833.1b/0_92a15_f45836_L.jpg)  
4\) Пинг с Сервера2 на ПК1  
[![](http://img-fotki.yandex.ru/get/6405/83739833.1b/0_92a16_9275441b_M.jpg)](http://img-fotki.yandex.ru/get/6405/83739833.1b/0_92a16_9275441b_L.jpg)

## Дополнения

1\) Правила, действующие на исходящий трафик \(out\) не будут фильтровать трафик самого устройства. То есть, если нужно запретить самой циске доступ куда-либо, то вам придётся на этом интерфейсе фильтровать входящий трафик \(ответный оттуда, куда надо запретить доступ\).

2\) C ACL надо быть аккуратнее. При небольшой ошибке в правиле, неправильном порядке настройки или вообще плохо продуманном списке вы можете остаться без доступа к устройству.  
Например, вы хотите закрыть доступ куда угодно для сети 172.16.6.0/24, кроме своего адреса 172.16.6.61 и задаёте правила так:

```text
deny ip 172.16.6.0 0.0.0.255 any
permit ip host 172.16.6.61 any
```

Как только вы примените ACL на интерфейс, вы сразу потеряете доступ к маршрутизатору, потому что вы попадаете под первое правило и второе даже не проверяется.  
Вторая неприятная ситуация, которая может с вами приключиться: под ACL попадёт трафик, который не должен был попасть.  
Вообразите такую ситуацию: у нас в серверной есть FTP-сервер в пассивном режиме. Для доступа к нему вы открыли 21-й порт в ACL _Servers-out_. После первичного установления соединения FTP-сервер сообщает клиенту порт, по которому он готов передавать/принимать файлы, например, 1523-й. Клиент пытается установить TCP-соединение на этот порт, но натыкается на ACL Servers-out, где такого разрешения нету — так и кончается сказка про успешный трансфер. В нашем примере выше, где мы настраивали доступ на файловый сервер, мы открыли доступ только по 20 и 21-му, потому что для примера этого достаточно. В реальной жизни придётся повозиться. Немного [примеров](http://www.cisco.com/en/US/tech/tk648/tk361/technologies_configuration_example09186a0080100548.shtml) конфигурации ACL для распространенных случаев.

3\) Из 2-го пункта вытекает очень похожая и интересная проблема.  
Вздумалось вам, например повесить на интерфейс в интернет такие вот ACL:

```text
access-list out permit tcp host 1.1.1.1 host 2.2.2.2 eq 80
access-list in permit tcp host 2.2.2.2 any eq 80
```

Казалось бы: хосту с адресом 1.1.1.1 разрешён доступ по 80-му порту на сервер 2.2.2.2 \(первое правило\). И обратно от сервера 2.2.2.2 разрешены соединения внутрь.  
Но нюанс тут в том, что компьютер 1.1.1.1 устанавливает соединение НА 80-й порт, но С какого-то другого, например, 1054, то есть ответный пакет от сервера приходит на сокет 1.1.1.1:1054, не подпадает под правило в ACL на IN и отбрасывается ввиду неявного deny ip any any.  
Чтобы избежать такой ситуации, и не открывать всем пучком порты, можно прибегнуть к такой хитрости в ACL на in:

```text
permit tcp host 2.2.2.2 any established. 
```

Подробности такого решения в одной из следующих статей.

4\) Говоря про современный мир, нельзя обойти такой инструмент, как объектные группы \(Object-group\).

Допустим, надо составить ACL, выпускающий три определенных адреса в интернет по трем одинаковым портам c перспективой расширения количества адресов и портов. Как это выглядит без знания объектных групп:

```text
ip access-list extended TO-INTERNET
permit tcp host 172.16.6.66 any eq 80
permit tcp host 172.16.6.66 any eq 8080
permit tcp host 172.16.6.66 any eq 443
permit tcp host 172.16.6.67 any eq 80
permit tcp host 172.16.6.67 any eq 8080
permit tcp host 172.16.6.67 any eq 443
permit tcp host 172.16.6.68 any eq 80
permit tcp host 172.16.6.68 any eq 8080
permit tcp host 172.16.6.68 any eq 443
```

При увеличении количества параметров сопровождать такой ACL становится всё труднее и труднее, легко ошибиться при настройке.  
Зато, если обратиться к объектным группам, то это приобретает следующий вид:

```text
object-group service INET-PORTS
description Ports allowed for some hosts
tcp eq www
tcp eq 8080
tcp eq 443

object-group network HOSTS-TO-INET
description Hosts allowed to browse the net
host 172.16.6.66
host 172.16.6.67
host 172.16.6.68

ip access-list extended INET-OUT
permit object-group INET-PORTS object-group HOSTS-TO-INET any
```

на первый взгляд несколько угрожающе выглядит, но если разобраться, то это очень удобно.

4\) Очень полезную для траблшутинга информацию можно получить из вывода команды **show ip access-lists %имя ACL%**. Кроме собственно списка правил указанного ACL, эта команда показывает количество совпадений по каждому правилу.

```text
msk-arbat-gw1#sh ip access-lists nat-inet
Extended IP access list nat-inet
permit tcp 172.16.3.0 0.0.0.255 host 192.0.2.2 eq www
permit ip 172.16.5.0 0.0.0.255 host 192.0.2.3
permit ip 172.16.5.0 0.0.0.255 host 192.0.2.4
permit ip host 172.16.4.123 any
permit ip host 172.16.6.61 any
permit ip host 172.16.6.66 any(4 match(es))
permit ip host 172.16.16.222 any
permit ip host 172.16.17.222 any
permit ip host 172.16.24.222 any
```

А дописав в конце любого правила **log**, мы сможем получать сообщения о каждом совпадении в консоль. \(последнее не работает в PT\)
