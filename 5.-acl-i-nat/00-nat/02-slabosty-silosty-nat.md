# Слабости и силости NAT

## +

**— В первую очередь** NAT позволяет сэкономить публичные IP-адреса. Собственно для этого он и был создан. Через один адрес, теоретически можно выпустить больше 65000 серых адресов \(по количеству портов\).  
**— Во-вторых**, PAT и динамический NAT является в какой-то степени файрволом, препятствуя внешним соединениям доходить до конечных компьютеров, на которых может не оказаться своего файрвола и антивируса. Дело в том, что если извне на натирующее устройство приходит пакет, который тут не ожидается или не разрешён, он просто отбрасывается.  
Чтобы пакет был пропущен и обработан, должны выполниться следующие условия:  
1\) В NAT-таблице должна быть запись для этого внешнего адреса, указанного как адрес отправителя в пакете  
И  
2\) Порт отправителя в пакете должен совпадать с портом для этого белого адреса в записи  
И  
3\) Порт назначения в пакете, совпадает с портом в записи.  
ИЛИ  
Настроен проброс портов.  
Но не нужно рассматривать NAT именно как файрвол — это не более, чем дополнительная его плюшка.

**— В-третьих**, NAT скрывает от посторонних глаз внутреннюю структуру вашей сети — при трассировке маршрута извне вы не увидите ничего далее натирующего устройства.

## -

Есть у NAT’а и минусы. Самые ощутимые из них, пожалуй, следующие:  
— Некоторые протоколы не могут работать через NAT без костылей. Например, FTP или протоколы туннелирования \(несмотря на то, как просто я настроил FTP в лабораторке, в реальной жизни это может создать кучу проблем\)  
— Другая проблема кроется в том, с одного адреса идёт много запросов на один сервер. Многие были свидетелем этого, когда заходишь на какой-нибудь Rapidshare, а он говорит, что с вашего IP уже было соединение, вы думаете, что “врёт, собака”, а это ваш сосед уже сосет. По этой же причине бывали проблемы c ICQ, когда сервера отказывали в регистрации.  
— Не очень актуальная сейчас проблема: нагрузка на процессор и оперативную память. Поскольку объём работы довольно велик по сравнению с простой маршрутизацией \(это надо не просто глянуть заголовок IP, надо его снять, TCP-заголовок снять, в таблицу занести, новые заголовки прикрутить\) в мелких конторах с этим бывают проблемы.  
Я [сталкивался](http://habrahabr.ru/post/111990/) с такой ситуацией.  
Одно из возможных решений — вынести функцию NAT на отдельный ПК либо на специализированное устройство, например Cisco ASA.  
Для больших игроков, у которых маршрутизаторы ворочают по 3-4 BGP full-view, сейчас это не составляет проблем.

Что ещё нужно знать?  
— NAT применяется в основном для обеспечения доступа в Интернет хостам с приватными адресами. Но бывает и иное применение — связь между двумя частными сетями с пересекающимися адресными пространствами.  
Например, ваша компания покупает себе филиал в Актюбинске. У вас адресация 10.0.0.0-10.1.255.255, а у них 10.1.1.0-10.1.10.255. Диапазоны явно пересекаются, настроить маршрутизацию никак не получится, потому что один и тот же адрес может оказаться и в Актюбинске и у вас в штаб-квартире.  
В таком случае на месте стыка настраивается NAT. Поскольку серых адресов у нас не мерено, можно выделить, к примеру, диапазон 10.2.1.0-10.2.10.255 и делать трансляцию один-в-один:  
10.1.1.1-10.2.1.1  
10.1.1.2-10.2.1.2  
…  
10.1.10.255-10.2.10.255

— В больших игрушках для взрослых NAT может быть реализован на отдельной плате \(и часто так и есть\) и без неё не заработает. А на офисных железках, напротив, есть почти всегда.

— С повсеместным внедрением IPv6 необходимость в NAT’e будет сходить на нет. Уже сейчас большие заказчики начинают интересоваться функционалом NAT64 — это когда у вас выход в мир через IPv4, а внутренняя сеть уже на IPv6

— Разумеется, это лишь поверхностный взгляд на NAT и есть ещё море нюансов, не утонуть в котором вам поможет самообразование.

