# Сети для самых маленьких. Часть третья. Статическая маршрутизация

_Мальчик сказал маме: “Я хочу кушать”. Мама отправила его к папе.  
Мальчик сказал папе: “Я хочу кушать”. Папа отправил его к маме.  
Мальчик сказал маме: “Я хочу кушать”. Мама отправила его к папе.  
И бегал так мальчик, пока в один момент не упал.  
Что случилось с мальчиком? TTL кончился._  

Итак, поворотный момент в истории компании “Лифт ми Ап”. Руководство понимает, что компания, производящая лифты, едущие только вверх, не выдержит борьбы на высококонкурентном рынке. Необходимо расширять бизнес. Принято решение о покупке двух заводов: в Санкт-Петербурге и Кемерово.  
Нужно срочно организовывать связь до новых офисов, а у вас ещё даже локалка не заработала.  
Сегодня:  

1.  Настраиваем маршрутизацию между вланами в нашей сети (InterVlan routing)
2.  Пытаемся разобраться с процессами, происходящими в сети, и что творится с данными
3.  Планируем расширение сети (IP-адреса, вланы, таблицы коммутации)
4.  Настраиваем статическую маршрутизацию и разбираемся, как она работает
5.  Используем L3-коммутатор в качестве шлюза

Содержание:  

*   InterVlan Routing
*   Планирование расширения  
    *   IP-план
*   Принципы маршрутизации
*   Настройка  
    *   Москва. Арбат
    *   Провайдер
    *   Санкт-Петербург. Васильевский остров
    *   Санкт-Петербург. Озерки
    *   Кемерово. Красная горка
*   Дополнительно
*   Материалы выпуска

# InterVlan Routing

Чуточку практики для взбадривания.  
В [предыдущий](https://linkmeup.ru/blog/13.html) раз мы настроили коммутаторы нашей локальной сети. На данный момент устройства разных вланов не видят друг друга. То есть фактически ФЭО и ПТО, например, находятся в совершенно разных сетях и не связаны друг с другом. Так же и серверная сеть существует сама по себе. Надо бы исправить эту досадную неприятность.  
В нашей московской сети для маршрутизации между вланами мы будем использовать роутер cisco 2811\. Иными словами он будет терминировать вланы. Кадры здесь заканчивают свою жизнь: из них извлекаются IP-пакеты, а заголовки канального уровня отбрасываются.  

![](http://img-fotki.yandex.ru/get/5904/83739833.16/0_83196_8c1055b6_XL.jpg)  

Процесс настройки маршрутизатора очень прост:  

0) Сначала закончим с коммутатором msk-arbat-dsw1\. На нём нам нужно настроить транковый порт в сторону маршрутизатора, чего мы не сделали в прошлый раз.  

    msk-arbat-dsw1(config)#interface FastEthernet0/24
    msk-arbat-dsw1(config-if)# description msk-arbat-gw1
    msk-arbat-dsw1(config-if)# switchport trunk allowed vlan 2-3,101-104
    msk-arbat-dsw1(config-if)# switchport mode trunk

1) Назначаем имя маршрутизатора командой **hostname**, а для развития хорошего тона, надо упомянуть, что лучше сразу же настроить время на устройстве. Это поможет вам корректно идентифицировать записи в логах.  

    Router0#clock set 12:34:56 7 august 2012
    Router0# conf t
    Router0(config)#hostname msk-arbat-gw1

Желательно время на сетевые устройства раздавать через [NTP](http://ru.wikipedia.org/wiki/Ntp) (любую циску можно сделать NTP-сервером, кстати)  

2) Далее переходим в режим настройки интерфейса, обращённого в нашу локальную сеть и включаем его, так как по умолчанию он находится в состоянии Administratively down.  

    msk-arbat-gw1(config)#interface fastEthernet 0/0
    msk-arbat-gw1(config-if)#no shutdown 

3) Создадим виртуальный интерфейс или иначе его называют подинтерфейс или ещё сабинтерфейс (sub-interface).  

    msk-arbat-gw1(config)#interface fa0/0.2
    msk-arbat-gw1(config-if)#description Management

Логика тут простая. Сначала указываем обычным образом физический интерфейс, к которому подключена нужная сеть, а после точки ставим некий уникальный идентификатор этого виртуального интерфейса. Для удобства, обычно номер сабинтерфейса делают аналогичным влану, который он терминирует.  

4) Теперь вспомним о стандарте [802.1q](http://xgu.ru/wiki/802.1Q), который описывает тегирование кадра меткой влана. Следующей командой вы обозначаете, что кадры, исходящие из этого виртуального интерфейса будут помечены тегом 2-го влана. А кадры, входящие на физический интерфейс FastEthernet0/0 с тегом этого влана будут приняты виртуальным интерфейсом FastEthernet0/0.2.  

    msk-arbat-gw1(config-if)#encapsulation dot1Q 2

5) Ну и как на обычном физическом L3-интерфейсе, определим IP-адрес. Этот адрес будет шлюзом по умолчанию (default gateway) для всех устройств в этом влане.  

    msk-arbat-gw1(config-if)#ip address 172.16.1.1 255.255.255.0

Аналогичным образом настроим, например, 101-й влан:  

    msk-arbat-gw1(config)#interface FastEthernet0/0.101
    msk-arbat-gw1(config-if)#description PTO
    msk-arbat-gw1(config-if)#encapsulation dot1Q 101
    msk-arbat-gw1(config-if)#ip address 172.16.3.1 255.255.255.0

и теперь убедимся, что с компьютера из сети ПТО мы видим сеть управления:  
![](http://img-fotki.yandex.ru/get/6101/83739833.14/0_81a6b_f5e01ab7_XL.jpg)  

Работает и отлично, настройте пока все остальные интерфейсы. Проблем с этим возникнуть не должно.  

## Физика и логика процесса межвланной маршрутизации

Что происходит в это время с вашими данными? Мы рассуждали в [прошлый раз](https://linkmeup.ru/blog/13.html), что происходит, если вы пытаетесь связаться с устройством из той же самой подсети, в которой находитесь вы. Под той же самой подсетью мы понимаем следующее: например, на вашем компьютере настроено следующее:  
IP: 172.16.3.2  
Mask: 255.255.255.0  
GW: 172.16.3.1  

Все устройства, адреса которых будут находиться в диапазоне 172.16.3.1-172.16.3.254 с такой же маской, как у вас, будут являться членами вашей подсети. Что происходит с данными, если вы отправляете их на устройство с адресом из этого диапазона? Повторим это с некоторыми дополнениями.  

Для отправки данных они должны быть упакованы в Ethernet-кадр, в заголовок которого должен быть вставлен MAC-адрес удалённого устройства. Но откуда его взять?  
Для этого ваш компьютер рассылает широковещательный ARP-запрос. В качестве IP-адреса узла назначения в IP-пакет с этим запросом будет помещён адрес искомого хоста. Сетевая карта при инкапсуляции указывает MAC-адрес FF:FF:FF:FF:FF:FF — это значит, что кадр предназначен всем устройствам. Далее он уходит на ближайший коммутатор и копии рассылаются на все порты нашего влана (ну, кроме, конечно, порта, из которого получен кадр). Получатели видят, что запрос широковещательный и они могут оказаться искомым хостом, поэтому извлекают данные из кадра. Все те устройства, которые не обладают указанным в ARP-запросе IP-адресом, просто игнорируют запрос, а вот устройство-настоящий получатель ответит на него и вышлет первоначальному отправителю свой MAC-адрес. Отправитель (в данном случае, наш компьютер) помещает полученный MAC в свою таблицу соответствия IP и MAC адресов ака ARP-кэш. Как выглядит ARP-кэш на вашем компьютере прямо сейчас, вы можете посмотреть с помощью команды **arp -a**  
![](http://img-fotki.yandex.ru/get/6105/83739833.16/0_838ff_c9405fb3_XL.jpg)  

Потом ваши полезные данные упаковываются в IP-пакет, где в качестве получателя ставится тот адрес, который вы указали в команде/приложении, затем в Ethernet-кадр, в заголовок которого помещается полученный ARP-запросом MAC-адрес. Далее кадр отправляется на коммутатор, который, согласно своей таблице MAC-адресов, решает, в какой порт его переправить дальше.  

Но что происходит, если вы пытаетесь достучаться до устройства в другом влане? ARP-запрос ничего не вернёт, потому что широковещательные L2 сообщения кончаются на маршрутизаторе(т.е., в пределах широковещательного L2 домена), нужная сеть находится за ним, а коммутатор не пустит кадры из одного влана в порт другого. И вот для этого нужен шлюз по умолчанию (default gateway) на вашем компьютере. То есть, если устройство-получатель в вашей же подсети, кадр просто отправляется в порт с мак-адресом конечного получателя. Если же сообщение адресовано в любую другую подсеть, то кадр отправляется на шлюз по умолчанию, поэтому в качестве MAC-адреса получателя подставится MAC-адрес маршрутизатора.  

Проследим за ходом событий.  

1) ПК с адресом 172.16.3.2/24 хочет отправить данные компьютеру с адресом 172.16.4.5.  
![](http://img-fotki.yandex.ru/get/6101/83739833.14/0_81ada_d08b99b3_XL.jpg)  
Он видит, что адрес из другой подсети, следовательно, данные должны уйти на шлюз по умолчанию. Но в таком случае, ПК нужен MAC-адрес шлюза. ПК проверяет свой ARP-кэш в поисках соответствия IP-адрес шлюза — MAC-адрес и не находит нужного  
![](http://img-fotki.yandex.ru/get/6100/83739833.14/0_81adb_3ffbe426_XL.jpg)  

2) ПК отправляет широковещательный ARP-запрос в локальную сеть. Структура ARP-запроса:  
— на канальном уровне в качестве получателя — широковещательный адрес ( FF:FF:FF:FF:FF:FF), в качестве отправителя — MAC-адрес интерфейса устройства, пытающегося выяснить IP  
— на сетевом — собственно ARP запрос, в нем содержится информация о том, какой IP и кем ищется.  
![](http://img-fotki.yandex.ru/get/5908/83739833.16/0_83900_cf328214_XL.jpg)  

3) Коммутатор, на который попал кадр, рассылает его копии во все порты этого влана (того, которому принадлежит изначальный хост), кроме того, откуда он получен.  
4) Все устройства, получив этот кадр и, видя, что он широковещательный, предполагают, что он адресован им.  
5) Распаковав кадр, все хосты, кроме маршрутизатора, видят, что в ARP-запросе не их адрес. А маршрутизатор посылает [unicast’овый](http://eucariot.livejournal.com/62043.html) ARP-ответ со своим MAC-адресом.  
6) Изначальный хост получает ARP-ответ, теперь у него есть MAC-адрес шлюза. Он формирует пакет из тех данных, что ему нужно отправить на 172.16.4.5\. **В качестве _MAC-адреса_ получателя ПК ставит адрес шлюза. При этом _IP-адрес_ получателя в пакете остаётся 172.16.4.5**  
![](http://img-fotki.yandex.ru/get/5607/83739833.14/0_81adc_2601877a_XL.jpg)  

7) Кадр посылается в сеть, коммутаторы доставляют его на маршрутизатор.  
8) На маршрутизаторе, в соответствии с меткой влана, кадр принимается конкретным сабинтерфейсом. **Данные канального уровня откидываются**.  
9) Из заголовка IP-пакета, рутер узнаёт адрес получателя, а из своей таблицы маршрутизации видит, что тот находится в непосредственно подключенной к нему сети на определённом сабинтерфейсе (в нашем случае FE0/0.102).  

    C 172.16.0.0/24 is directly connected, FastEthernet0/0.3
    C 172.16.1.0/24 is directly connected, FastEthernet0/0.2
    C 172.16.2.16/30 is directly connected, FastEthernet0/1.5
    C 172.16.3.0/24 is directly connected, FastEthernet0/0.101
    C 172.16.4.0/24 is directly connected, FastEthernet0/0.102
    C 172.16.5.0/24 is directly connected, FastEthernet0/0.103
    C 172.16.6.0/24 is directly connected, FastEthernet0/0.104

10) Маршрутизатор отправляет ARP-запрос с этого сабинтерфейса — узнаёт MAC-адрес получателя.  
11) Изначальный IP-пакет, не **изменяясь** инкапсулируется в **новый кадр**, при этом:  

*   в качестве MAC-адреса источника указывается адрес интерфейса шлюза
*   IP-адрес источника — адрес изначального хоста (в нашем случае 172.16.3.2)
*   в качестве MAC-адреса получателя указывается адрес конечного хоста
*   IP-адрес получателя — адрес конечного хоста (в нашем случае 172.16.4.5)

и отправляется в сеть с сабинтерфейса FastEthernet0/0.102, получая при этом метку 102-го влана.  

12) Кадр доставляется коммутаторами до хоста-получателя.  

# Планирование расширения

Теперь обратимся к планированию. В нулевой части мы уже затронули эту тему, но тогда речь была только о двух офисах в Москве, теперь же сеть растёт.  

Будет она вот такой:  
![](http://img-fotki.yandex.ru/get/6204/83739833.16/0_83901_7a5483b7_XL.jpg)  

То есть прибавляются две точки в Санкт-Петербурге: небольшой офис на Васильевском острове и сам завод в Озерках — и одна в Кемерово в районе Красная горка. Для простоты у нас будет один провайдер “Балаган Телеком”, который на выгодных условиях предоставит нам L2VPN до обеих точек. В одном из следующих выпусков мы тему различных вариантов подключения раскроем в красках. А пока вкратце: L2VPN — это, очень грубо говоря, когда вам провайдер предоставляет влан от точки до точки (можно для простоты представить, что они включены в один коммутатор).  

Следует сказать несколько слов об IP-адресации и делении на подсети. В нулевой части мы уже затронули вопросы планирования, весьма вскользь, надо сказать. Вообще, в любой более или менее большой компании должен быть некий регламент — свод правил, следуя которому вы распределяете IP-адреса везде. Сеть у нас сейчас разрастается и разработать его очень важно.  

Ну вот к примеру, скажем, что для офисов в других городах это будет так:  
![](http://img-fotki.yandex.ru/get/6202/83739833.16/0_82fef_6bef2d18_L.jpg)  

Это весьма упрощённый регламент, но теперь мы во всяком случае точно знаем, что у шлюза всегда будет 1-й адрес, до 12-го мы будем выдавать коммутаторам и всяким wi-fi-точкам, а все сервера будем искать в диапазоне 172.16.х.13-172.16.х.23\. Разумеется, по своему вкусу вы можете уточнять регламент вплоть до адреса каждого сервера, добавлять в него правило формирования имён устройств, доменных имён, политику списков доступа и т.д. Чем точнее вы сформулируете правила и строже будете следить за их выполнением, тем проще разбираться в структуре сети, решать проблемы, адаптироваться к ситуации <s>и наказывать виновных</s>. Это примерно, как схема запоминания паролей: когда у вас есть некое правило их формирования, вам не нужно держать в голове несколько десятков сложнозапоминаемых паролей, вы всегда можете их вычислить. Вот так же и тут. Я некогда работал в средних размеров холдинге и знал, что если я приеду в офис где-нибудь в забытой коровами деревне, то там точно x.y.z.1 — это циска, x.y.z.2 — дистрибьюшн-свитч прокурва, а x.y.z.101 — компьютер главного бухгалтера, с которого надо дать доступ на какой-нибудь контур-экстерн. Другой вопрос, что надо это ещё проверить, потому что местные ИТшники такого порой наворотят, что слезами омываешься сквозь смех.  

> Было дело парнишка решил сам управлять всем доступом в интернет (обычно это делал я на маршрутизаторе). Поставил proxy-сервер, случайно поднял на нём NAT и зарулил туда трафик локальной сети, на всех машинах прописав его в качестве шлюза по умолчанию, а потом я минут 20 разбирался, как так: у них всё работает, а мы их не видим.

## IP-план

Теперь нам было бы весьма кстати составить IP-план. Будем исходить из того, что на всех трёх точках мы будем использовать стандартную сеть с маской 24 бита (255.255.255.0) Это означает, что в них может быть 254 устройства.  

Почему это так? И как вообще понять все эти маски подсетей? В рамках одной статьи мы не сможем этого рассказать, иначе она получится длинная, как палуба Титаника и запутанная, как одесские катакомбы. Крайне рекомендуем очень плотно познакомиться с такими понятиями, как IP-адрес, маска подсети, их представления в двоичном виде и CIDR (Classless InterDomain Routing) самостоятельно. Мы же далее будем только аргументировать выбор конкретного размера сети. Как бы то ни было, полное понимание придёт только с практикой.  
Вообще, очень неплохо эта тема раскрыта в этой статье: [http://habrahabr.ru/post/129664/](http://habrahabr.ru/post/129664/)  

В данный момент (вспомним [нулевой выпуск](https://linkmeup.ru/blog/11.html)) у нас в Москве использованы адреса 172.16.0.0-172.16.6.255\. Предположим, что сеть может ещё увеличиться здесь, допустим, появится офис на Воробьёвых горах и зарезервируем ещё подсети до 172.16.15.0/24 включительно.  
Все эти адреса: 172.16.0.0-172.16.15.255 — можно описать так: 172.16.0.0/20\. Эта сеть (с префиксом /20) будет так называемой _суперсетью_, а операция объединения подсетей в суперсети называется _суммированием_ подсетей (суммированием маршрутов, если быть точным, route summarization)  

Очень наглядный [IP-калькулятор](http://www.ispreview.ru/ipcalc.html). Я и сейчас им периодически пользуюсь, хотя со временем приходит интуитивное и логическое понимание соответствия между длиной маски и границами сети.  

Теперь обратимся к Питеру. В данный момент в этом прекрасном городе у нас 2 точки и на каждой из них подсети /24\. Допустим это будут 172.16.16.0/24 и 172.16.17.0/24\. Зарезервируем адреса 172.16.18.0-172.16.23.255 для возможного расширения сети.  

172.16.16.0-172.16.23.255 можно объединить в 172.16.16.0/21 — в общем-то исходя именно из этого мы и оставляем в резерв именно такой диапазон.  

В Кемерово нам нет смысла оставлять такие огромные запасы /21, как в Питере (2048 адресов или 8 подсетей /24), или тем более /20, как в Москве (4096 или 16 подсетей /24). А вот 1024 адреса и 4 подсети /24, которым соответствует маска /22 вполне рационально.  

Таким образом сеть 172.16.24.0/22 (адреса 172.16.24.0-172.16.27.255) будет у нас для Кемерово.  

![](http://img-fotki.yandex.ru/get/6103/83739833.16/0_82ff0_2c5ff40_L.jpg)  

Тут надо бы заметить: делать такой запас в общем-то необязательно и то, что мы зарезервировали вполне можно использовать в любом другом месте сети. Нет табу на этот счёт. Однако в крупных сетях именно так и рекомендуется делать и связано это с количеством информации в таблицах маршрутизации.  
Понимаете ли дело вот в чём: если у вас несколько подряд идущих подсетей разбросаны по разным концам сети, то каждой из них соответствует одна запись в таблице маршрутизации каждого маршрутизатора. Если при этом вы вдруг используете только статическую маршрутизацию, то это ещё колоссальный труд по настройке и отслеживанию корректности настройки.  
А если же они у вас все идут подряд, то несколько маленьких подсетей вы можете суммировать в одну большую.  
Поясним на примере Санкт-Петербурга. При настройке статической маршрутизации мы могли бы делать так:  

    ip route 172.16.16.0 255.255.255.0 172.16.2.2
    ip route 172.16.17.0 255.255.255.0 172.16.2.2
    ip route 172.16.18.0 255.255.255.0 172.16.2.2
    ……
    ip route 172.16.23.0 255.255.255.0 172.16.2.2

Это 8 команд и 8 записей в таблице. Но при этом пришедший на маршрутизатор пакет в любую из сетей 172.16.16.0/21 в любом случае будет отправлен на устройство с адресом 172.16.2.2.  
Вместо этого мы поступим так:  

    ip route 172.16.16.0 255.255.248.0 172.16.2.2

И вместо восьми возможных сравнений будет только одно.  
Для современных устройств ни в плане процессорного времени ни использования памяти это уже не является существенной нагрузкой, однако такое планирование считается правилами хорошего тона и в конечном итоге вам же самим проще разобраться. Положа руку на сердце, такое планирование скорее исключение, нежели правило: так или иначе фрагментация маршрутов с ростом сети неизбежна.  

Теперь ещё несколько слов о _линковых_ сетях. В среде сетевых администраторов так называются сети точка-точка (Point-to-Point) между двумя маршрутизаторами.  
Вот опять же в примере с Питером. Два маршрутизатора (в Москве и в Петербурге) соединены друг с другом прямым линком (неважно, что у провайдера это сотня коммутаторов и маршрутизаторов — для нас это просто влан). То есть кроме вот этих 2-х устройств здесь не будет никаких других. Мы знаем это наверняка. В любом случае на интерфейсах обоих устройств (смотрящих в сторону друг друга) нужно настраивать IP-адреса. И нам точно незачем назначать на этом участке сеть /24 с 254 доступными адресами, ведь 252 в таком случае пропадут почём зря. В этом случае есть прекрасный выход — бесклассовая IP-адресация.  

Почему она бесклассовая? Если вы помните, то в нулевой части мы говорили о трёх классах подсетей: А, В и С. По идее только их вы и могли использовать при планировании сети. Бесклассовая междоменная маршрутизация ([CIDR](http://mannix.ru/poleznoe/besklassovaya-adresaciya-cidr.html)) позволяет очень гибко использовать пространство IP-адресов.  

Мы просто берём сеть с самой маленькой возможной маской — 30 (255.255.255.252) — это сеть на 4 адреса. Почему мы не можем взять сеть с ещё более узкой маской? Ну 32 (255.255.255.255) по понятными причинам — это вообще один единственный адрес, сеть 31 (255.255.255.254) — это уже 2 адреса, но один из них (первый) — это адрес сети, а второй (последний) — широковещательный. В итоге на адреса хостов у нас и не осталось ничего. Поэтому и берём маску 30 с 4 адресами и тогда как раз 2 адреса остаются на наши два маршрутизатора.  

Вообще говоря, самой узкой маской для подсетей в cisco таки является /31\. При определённых условиях их можно использовать на P-t-P-линках.  
Что же касается маски /32, то такие подсети, которые суть один единственный хост, используются для назначения адресов Loopback-интерфейсам.  

Именно так мы и поступим. Для этого, собственно, в нулевой части мы и оставили сеть 172.16.2.0/24 — её мы будем дробить на мелкие сетки /30\. Всего их получится 64 штуки, соответственно можно назначить их на 64 _линка_.  

![](http://img-fotki.yandex.ru/get/6202/83739833.16/0_82ffd_7d77a589_XL.jpg)  

Здесь мы поступили так же, как и в предыдущем случае: сделали небольшой резерв для Питера, и резерв для Кемерово. Вообще резерв — это всегда очень хорошо о чём бы мы ни говорили. ;)  

# Принципы маршрутизации

Перед началом настройки стоит определиться с тем, для чего нужна маршрутизация вообще.  
Рассмотрим такую сеть:  
![](http://img-fotki.yandex.ru/get/6103/83739833.16/0_82ffe_81ef48b2_XL.jpg)  

Вот к примеру с компьютера ПК1 — 172.16.3.2 я хочу подключиться по telnet к L3-коммутатору с адресом 172.16.17.1.  
Как мой компьютер узнает что делать? Куда слать данные?  

1) Как вы уже знаете, если адрес получателя из другой подсети, то данные нужно отправлять на шлюз по умолчанию.  
2) По уже известной вам схеме компьютер с помощью ARP-запроса добывает MAC-адрес маршрутизатора.  
3) Далее он формирует кадр с инкапсулированным в него пакетом и отсылает его в порт. После того, как кадр отправлен, компьютеру уже по барабану, что происходит с ним дальше.  
4) А сам кадр при этом попадает сначала на коммутатор, где решается его судьба согласно таблице MAC-адресов. А потом достигает маршрутизатора RT1.  
5) Поскольку маршрутизатор ограничивает широковещательный домен — здесь жизнь этого кадра и заканчивается. Циска просто откидывает заголовок канального уровня — он уже не пригодится — извлекает из него IP-пакет.  
6) Теперь маршрутизатор должен принять решение, что с ним делать дальше. Разумеется, отправить его на какой-то свой интерфейс. Но на какой?  
Для этого существует таблица маршрутизации, которая есть на любом рутере. Выяснить, что у нас в данный момент находится в таблице маршрутизации, можно с помощью команды **show ip route**:  

    172.16.0.0/16 is variably subnetted, 10 subnets, 3 masks
    C 172.16.3.0/24 is directly connected, FastEthernet0/0.101
    C 172.16.2.0/30 is directly connected, FastEthernet0/1.4
    S 172.16.17.0/24 [1/0] via 172.16.2.2

Каждая строка в ней — это способ добраться до той или иной сети.  
Вот к примеру, если пакет адресован в сеть 172.16.17.0/24, то данные нужно отправить на устройство с адресом 172.16.2.2.  
Таблица маршрутизации формируется из:  
— непосредственно подключенных сетей (directly connected) — это сети, которые начинаются непосредственно на нём. В примере 172.16.3.0/24 и 172.16.2.0/30\. В таблице они обозначаются буквой **C**  
— статический маршруты — это те, которые вы прописали вручную командой **ip route**. Обозначаются буквой **S**  
— маршруты, полученные с помощью протоколов динамической маршрутизации (OSPF, EIGRP, RIP и других).  

7) Итак, данные в сеть 172.16.17.0 (а мы хотим подключиться к устройству 172.16.17.1) должны быть отправлены на следующий хоп — следующий прыжок, которым является маршрутизатор 172.16.2.2\. Причём из таблицы маршрутизации видно, что находится следующий хоп за интерфейсом FE0/1.4 (подсеть 172.16.2.0/30).  
8)Если в ARP-кэше циски нет MAC-адреса, то надо снова выполнить ARP-запрос, чтобы узнать MAC-адрес устройства с IP-адресом 172.16.2.2\. RT1 посылает широковещательный кадр с порта FE0/1.4\. В этом широковещательном домене у нас два устройства, и соответственно только один получатель. RT2 получает ARP-запрос, отбрасывает заголовок Ethernet и, понимая из данных протокола ARP, что искомый адрес принадлежит ему отправляет ARP-ответ со своим MAC-адресом.  
9) Изначальный IP-пакет, пришедший на RT1 **не меняется**, он инкапсулируется в **совершенно новый кадр** и отправляется в порт FE0/1.4, получая при этом метку 4-го влана.  
10) Полностью аналогичные действия происходят на следующем маршрутизаторе. И на следующем и следующем (если бы они были), пока пакет не дойдёт до последнего, к которому и подключена нужная сеть.  
11) Последний маршрутизатор (коим является L3-коммутатор) видит, что искомый адрес принадлежит ему самому, а извлекая данные транспортного уровня, понимает, что это телнет и передаёт все данные верхним уровням.  

Так вот и путешествуют данные с одного хопа на другой и ни один маршрутизатор представления не имеет о дальнейшей судьбе пакета. Более того, он даже не знает есть ли там действительно эта сеть — он просто доверяет своей таблице маршрутизации.  

# Настройка

Каким образом мы организуем каналы связи? Как мы уже сказали выше, в нашем офисе на Арбате есть некий провайдер Балаган-Телеком. Он обещает нам предоставить всё, что мы только захотим почти задарма. И мы заказываем у него две услуги L2VPN, то есть он отдаст нам два влана на Арбате в Москве, и по одному в Питере и Кемерово.  
Вообще говоря, номера вланов вам придётся согласовывать с вашим провайдером по той простой причине, что у него они могут быть просто заняты. Поэтому вполне возможно, что у вас будет влан, например, 2912 или 754\. Но предположим, что нам повезло, и мы вольны сами выбирать номер.  

### Москва. Арбат

На циске в Москве у нас два интерфейса, к одному — FE0/0 — уже подключена наша локальная сеть, а второй (FE0/1)мы будем использовать для выхода в интернет и для подключения удалённых офисов.  
Как и в самом начале создадим саб-интерфейсы. Выделим для Санкт-Петербурга и Кемерова 4 и 5-й вланы соответственно. IP-адреса берём из нового IP-плана.  

    msk-arbat-gw1(config)#interface FastEthernet 0/1.4
    msk-arbat-gw1(config-subif)#description Saint-Petersburg
    msk-arbat-gw1(config-subif)#encapsulation dot1Q 4
    msk-arbat-gw1(config-subif)#ip address 172.16.2.1 255.255.255.252
    msk-arbat-gw1(config)#interface FastEthernet 0/1.5
    msk-arbat-gw1(config-subif)#description Kemerovo
    msk-arbat-gw1(config-subif)#encapsulation dot1Q 5
    msk-arbat-gw1(config-subif)#ip address 172.16.2.17 255.255.255.252

### Провайдер

Разумеется, мы не будем строить всю сеть провайдера. Вместо этого просто поставим коммутатор, ведь по сути сеть провайдера с нашей точки зрения будет одним огромным абстрактным коммутатором.  

Тут всё просто: принимаем транком линк с Арбата в один порт и с двух других портов отдаём их на удалённые узлы. Ещё раз хотим <u>подчеркнуть</u>, что все эти 3 порта не принадлежат одному коммутатору — они разнесены на сотни километров, между ними сложная MPLS-сеть с кучей коммутаторов.  

Настраиваем “эмулятор провайдера”:  

    Switch(config)#vlan 4
    Switch(config-vlan)#vlan 5
    Switch(config)#interface fa0/1
    Switch(config-if)#switchport mode trunk 
    Switch(config-if)#switchport trunk allowed vlan 4-5
    Switch(config-if)#exit
    Switch(config)#int fa0/2
    Switch(config-if)#switchport trunk allowed vlan 4
    Switch(config-if)#int fa0/3
    Switch(config-if)#switchport trunk allowed vlan 5

### Санкт-Петербург. Васильевский остров

Теперь обратимся к нашему spb-vsl-gw1\. Тут у нас тоже 2 порта, но решим вопрос нехватки портов иначе: добавим сюда плату. Плата с двумя FastEthernet-портам и двумя слотами для WIC вполне подойдёт.  

![](http://img-fotki.yandex.ru/get/5606/83739833.14/0_819ec_bf9c3159_XL.jpg)  

Пусть встроенные порты будут для локальной сети, а порты на дополнительной плате мы используем для аплинка и связи с Озерками.  

![](http://img-fotki.yandex.ru/get/6101/83739833.14/0_819ed_12b6f87_L.jpg)  

Здесь вы можете увидеть отличие в нумерации портов и понять их смысл.  
FastEthernet — это тип порта (Ethernet, Fastethernet, GigabitEthernet, POS, Serial или другие)  
x/y/z.w=Slot/Sub-slot/Interface.Sub-interface.  

Каким образом здесь вам провайдер будет отдавать канал — транком или аксесом, вы решаете сообща. Как правило, для него не составит проблем ни один из вариантов.  
Но мы уже настроили транк, поэтому соответствующим образом настраиваем порт на циске:  

    spb-vsl-gw1(config)interface FastEthernet1/0.4
    spb-vsl-gw1(config-if)description Moscow
    spb-vsl-gw1(config-if)encapsulation dot1Q 4
    spb-vsl-gw1(config-if)ip address 172.16.2.2 255.255.255.252

Добавим ещё локальную сеть:  

    spb-vsl-gw1(config)#int fa0/0
    spb-vsl-gw1(config-if)#description LAN
    spb-vsl-gw1(config-if)#ip address 172.16.16.1 255.255.255.0

Вернёмся в Москву. С msk-arbat-gw1 мы можем увидеть адрес 172.16.2.2:  

    msk-arbat-gw1#ping 172.16.2.2

    Type escape sequence to abort.
    Sending 5, 100-byte ICMP Echos to 172.16.2.2, timeout is 2 seconds:
    !!!!!
    Success rate is 100 percent (5/5), round-trip min/avg/max = 2/7/13 ms

Но так же не видим 172.16.16.1:  

    msk-arbat-gw1#ping 172.16.16.1

    Type escape sequence to abort.
    Sending 5, 100-byte ICMP Echos to 172.16.16.1, timeout is 2 seconds:
    .....
    Success rate is 0 percent (0/5)

Опять же, потому что маршрутизатор не знает, куда слать пакет:  

    msk-arbat-gw1#sh ip route 

    Gateway of last resort is not set

    172.16.0.0/16 is variably subnetted, 8 subnets, 2 masks
    C 172.16.0.0/24 is directly connected, FastEthernet0/0.3
    C 172.16.1.0/24 is directly connected, FastEthernet0/0.2
    C 172.16.2.0/30 is directly connected, FastEthernet0/1.4
    C 172.16.3.0/24 is directly connected, FastEthernet0/0.101
    C 172.16.4.0/24 is directly connected, FastEthernet0/0.102
    C 172.16.5.0/24 is directly connected, FastEthernet0/0.103
    C 172.16.6.0/24 is directly connected, FastEthernet0/0.104

Исправим это недоразумение:  

    msk-arbat-gw1(config)#ip route 172.16.16.0 255.255.255.0 172.16.2.2

    msk-arbat-gw1#sh ip route 
    Codes: C - connected, S - static, I - IGRP, R - RIP, M - mobile, B - BGP
    D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area
    N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
    E1 - OSPF external type 1, E2 - OSPF external type 2, E - EGP
    i - IS-IS, L1 - IS-IS level-1, L2 - IS-IS level-2, ia - IS-IS inter area
    * - candidate default, U - per-user static route, o - ODR
    P - periodic downloaded static route

    Gateway of last resort is not set

    172.16.0.0/16 is variably subnetted, 9 subnets, 2 masks
    C 172.16.0.0/24 is directly connected, FastEthernet0/0.3
    C 172.16.1.0/24 is directly connected, FastEthernet0/0.2
    C 172.16.2.0/30 is directly connected, FastEthernet0/1.4
    C 172.16.2.16/30 is directly connected, FastEthernet0/1.5
    C 172.16.3.0/24 is directly connected, FastEthernet0/0.101
    C 172.16.4.0/24 is directly connected, FastEthernet0/0.102
    C 172.16.5.0/24 is directly connected, FastEthernet0/0.103
    C 172.16.6.0/24 is directly connected, FastEthernet0/0.104
    S 172.16.16.0/24 [1/0] via 172.16.2.2

Теперь пинг появляется:  

    msk-arbat-gw1#ping 172.16.16.1

    Type escape sequence to abort.
    Sending 5, 100-byte ICMP Echos to 172.16.16.1, timeout is 2 seconds:
    !!!!!
    Success rate is 100 percent (5/5), round-trip min/avg/max = 4/10/24 ms

Вот, казалось бы оно — счастье, но проверим связь с компьютера:  
![](http://img-fotki.yandex.ru/get/5608/83739833.14/0_81adf_50ceeace_XL.jpg)  

В чём дело?!  
Компьютер знает, куда отправлять пакет — на свой шлюз 172.16.3.1, маршрутизатор тоже знает — на хост 172.16.2.2\. Пакет уходит туда, принимается spb-vsl-gw1, который знает, что пингуемый адрес 172.16.16.1 принадлежит ему. А обратно нужно отправить пакет на адрес 172.16.3.3, но в сеть 172.16.3.0 у него нет маршрута. А пакеты, сеть назначения которых неизвестна, просто дропятся — отбрасываются.  

    spb-vsl-gw1#sh ip route 

    Gateway of last resort is not set

    172.16.0.0/16 is variably subnetted, 2 subnets, 2 masks
    C 172.16.2.0/30 is directly connected, FastEthernet1/0.4
    C 172.16.16.0/24 is directly connected, FastEthernet0/0

Но, почему же, спросите вы, с msk-arbat-gw1 до 172.16.16.1 пинг был? Какая разница 172.16.3.1 или 172.16.3.2? Всё просто.  
Из таблицы маршрутизации всем видно, что следующий хоп — 172.16.2.2, при этом адрес из 172.16.2.1 принадлежит интерфейсу этого маршрутизатора, поэтому он и ставится в заголовок в качестве IP-адреса отправителя, а не 172.16.3.1\. Пакет отправляется на spb-vsl-gw1, тот его принимает, передаёт данные приложению пинг, которое формирует echo-reply. Ответ инкапсулируется в IP-пакет, где в качестве адреса получателя фигурирует 172.16.2.1, а 172.16.2.0/30 — непосредственно подключенная к spb-vsl-gw1 сеть, поэтому без проблем пакет доставляется по назначению. То етсь в сеть 172.16.2.0/30 маршрут известен, а в 172.16.3.0/24 нет.  

Для решения этой проблемы мы можем прописать на spb-vsl-gw1 маршрут в сеть 172.16.3.0, но тогда придётся прописывать и для всех других сетей. Для всех сетей в Москве, потом в Кемерово, потом в других городах — очень большой объём настройки. Тут стоить заметить, что по сути у нас только один выход в мир — через Москву. Узел в Озерках — тупиковый, а других нет. То есть в основном все данные будут уходить в Москву, где большая часть подсетей и будет выход в интернет. Чем нам это может помочь? Есть такое понятие — маршрут по умолчанию, ещё он носит романтическое название шлюз — последней надежды. И второму есть объяснение. Когда маршрутизатор решает, куда отправить пакет, он просматривает всё таблицу маршрутизации и, если не находит нужного маршрута, пакет отбрасывается — это если у вас не настроен шлюз последней надежды, если же настроен, то сиротливые пакеты отправляются именно туда — просто не глядя, предоставляя право уже следующему хопу решать их дальнейшую судьбу. То есть если некуда отправить, то последняя надежда — маршрут по умолчанию.  
Настраивается он так:  

    spb-vsl-gw1(config)#ip route 0.0.0.0 0.0.0.0 172.16.2.1

И теперь тадааам:  

![](http://img-fotki.yandex.ru/get/6101/83739833.14/0_81add_91df3e72_XL.jpg)  

В случае таких тупиковых областей довольно часто применяется именно шлюз последней надежды, чтобы уменьшить количество маршрутов в таблице и сложность настройки.  

### Санкт-Петербург. Озерки

Теперь озаботимся Озерками. Здесь мы поставим L3-коммутатор. Допустим, связаны они у нас будут арендованным у провайдера волокном (конечно, это идеализированная ситуация для маленькой компании, но можно же помечтать). Использование коммутаторов третьего уровня весьма удобно в некоторых случаях. Во-первых, интервлан роутинг в этом случае делается аппаратно и не нагружает процессор, в отличие от маршрутизатора. Кроме того, один L3-коммутатор обойдётся вам значительно дешевле, чем L2-коммутатор и маршрутизатор по отдельности. Правда, при этом вы лишаетесь ряда функций, естественно. Поэтому при выборе решения будьте аккуратны.  

Настроим маршрутизатор на Васильевском острове, согласно плану:  

    spb-vsl-gw1(config)interface fa1/1
    spb-vsl-gw1(config-if)#description Ozerki
    spb-vsl-gw1(config-if)#ip address 172.16.2.5 255.255.255.252

Поскольку мы уже запланировали сеть для Озерков 172.16.17.0/24, то можем сразу прописать туда маршрут:  

    spb-vsl-gw1(config)#ip route 172.16.17.0 255.255.255.0 172.16.2.6

В качестве некст хопа ставим адрес, который мы выделили для линковой сети на Озерках — 172.16.2.6  

Теперь перенесёмся в сами Озерки:  
Подключим кабель в уже настроенный порт fa1/1 на стороне Васильевского острова и в 24-й порт 3560 в Озерках. По умолчанию все порты L3-коммутатора работают в режиме L2, то есть это обычные “свитчёвые” порты, на которых мы можем настроить вланы. Но любой из них мы можем перевести в L3-режим, сделав портом маршрутизатора. Тогда на нём мы сможем настроить IP-адрес:  

    Switch(config)#hostname spb-ozerki-gw1
    spb-ozerki-gw1(config)#interface fa0/24
    spb-ozerki-gw1(config-if)#no switchport 
    spb-ozerki-gw1(config-if)#ip address 172.16.2.6 255.255.255.252

Проверяем связь:  

    spb-ozerki-gw1#ping 172.16.2.5

    Type escape sequence to abort.
    Sending 5, 100-byte ICMP Echos to 172.16.2.5, timeout is 2 seconds:
    .!!!!
    Success rate is 80 percent (4/5), round-trip min/avg/max = 1/18/61 ms

Настроим ещё локальную сеть. Напомним, что Cisco и другие производители и не только производители не рекомендуют использовать 1-й влан, поэтому, мы воспользуемся 2-м:  

    spb-ozerki-gw1(config)#vlan 2
    spb-ozerki-gw1(config-vlan)#name LAN
    spb-ozerki-gw1(config-vlan)#exit
    spb-ozerki-gw1(config)#interface vlan 2
    spb-ozerki-gw1(config-if)#description LAN
    spb-ozerki-gw1(config-if)#ip address 172.16.17.1 255.255.255.0
    spb-ozerki-gw1(config)#interface fastEthernet 0/1
    spb-ozerki-gw1(config-if)#description Pupkin
    spb-ozerki-gw1(config-if)#switchport mode access 
    spb-ozerki-gw1(config-if)#switchport access vlan 2

После этого все устройства во втором влане будут иметь шлюзом 172.16.17.1  

![](http://img-fotki.yandex.ru/get/5607/83739833.14/0_81ade_2869e853_XL.jpg)  

Чтобы коммутатор превратился в почти полноценный маршрутизатор, надо дать ещё одну команду:  

    spb-ozerki-gw1(config)#ip routing 

Таким образом мы включим возможность маршрутизации.  

Никаких других маршрутов, кроме как по умолчанию нам тут не надо:  

    spb-ozerki-gw1(config)#ip route 0.0.0.0 0.0.0.0 172.16.2.5

Связь до spb-vsl-gw1 есть:  

    spb-ozerki-gw1#ping 172.16.16.1

    Type escape sequence to abort.
    Sending 5, 100-byte ICMP Echos to 172.16.16.1, timeout is 2 seconds:
    !!!!!
    Success rate is 100 percent (5/5), round-trip min/avg/max = 3/50/234 ms

А до Москвы нет:  

    spb-ozerki-gw1#ping 172.16.3.1

    Type escape sequence to abort.
    Sending 5, 100-byte ICMP Echos to 172.16.3.1, timeout is 2 seconds:
    .....
    Success rate is 0 percent (0/5)

Опять же дело в отсутствии маршрута. Вообще удобный инструмент для нахождения примерного места расположения проблемы traceroute:  

    spb-ozerki-gw1#traceroute 172.16.3.1
    Type escape sequence to abort.
    Tracing the route to 172.16.3.1

    1 172.16.2.5 4 msec 2 msec 5 msec 
    2 * * * 
    3 * * * 
    4 * 

Как видите, что от spb-vsl-gw1 ответ приходит, а дальше глухо. Это означает, как правило, что или на хопе с адресом 172.16.2.5 не прописан маршрут в нужную сеть (вспоминаем, что у нас настроен там маршрут по умолчанию, которого достаточно) или на следующем нету маршрута обратно:  

    msk-arbat-gw1#sh ip rou

    Gateway of last resort is not set

    172.16.0.0/16 is variably subnetted, 9 subnets, 2 masks
    C 172.16.0.0/24 is directly connected, FastEthernet0/0.3
    C 172.16.1.0/24 is directly connected, FastEthernet0/0.2
    C 172.16.2.0/30 is directly connected, FastEthernet0/1.4
    C 172.16.2.16/30 is directly connected, FastEthernet0/1.5
    C 172.16.3.0/24 is directly connected, FastEthernet0/0.101
    C 172.16.4.0/24 is directly connected, FastEthernet0/0.102
    C 172.16.5.0/24 is directly connected, FastEthernet0/0.103
    C 172.16.6.0/24 is directly connected, FastEthernet0/0.104
    S 172.16.16.0/24 [1/0] via 172.16.2.2

Действительно маршрута в подсеть 172.16.17.0/24 нет. Мы можем прописать его, вы это уже умеете, а можем вспомнить, что целую подсеть 172.16.16.0/21 мы выделили под Питер, поэтому вместо того, чтобы по отдельности добавлять маршрут в каждую новую сеть, мы пропишем агрегированный маршрут:  

    msk-arbat-gw1(config)#no ip route 172.16.16.0 255.255.255.0 172.16.2.2
    msk-arbat-gw1(config)#ip route 172.16.16.0 255.255.248.0 172.16.2.2

Проверяем:  

    msk-arbat-gw1#ping 172.16.17.1

    Type escape sequence to abort.
    Sending 5, 100-byte ICMP Echos to 172.16.17.1, timeout is 2 seconds:
    !!!!!
    Success rate is 100 percent (5/5), round-trip min/avg/max = 4/10/18 ms

Но странной неожиданностью для вас может стать то, что с spb-ozerki-gw1 вы не увидите Москву по-прежнему:  

    spb-ozerki-gw1#ping 172.16.3.1

    Type escape sequence to abort.
    Sending 5, 100-byte ICMP Echos to 172.16.3.1, timeout is 2 seconds:
    .....
    Success rate is 0 percent (0/5)

Но при этом, если в качестве адреса-источника мы укажем 172.16.17.1:  

    spb-ozerki-gw1#ping 
    Protocol [ip]: 
    Target IP address: 172.16.3.1
    Repeat count [5]: 
    Datagram size [100]: 
    Timeout in seconds [2]: 
    Extended commands [n]: y
    Source address or interface: ping172.16.17.1
    % Invalid source
    Source address or interface: 172.16.17.1
    Type of service [0]: 
    Set DF bit in IP header? [no]: 
    Validate reply data? [no]: 
    Data pattern [0xABCD]: 
    Loose, Strict, Record, Timestamp, Verbose[none]: 
    Sweep range of sizes [n]: 
    Type escape sequence to abort.
    Sending 5, 100-byte ICMP Echos to 172.16.3.1, timeout is 2 seconds:
    Packet sent with a source address of 172.16.17.1
    !!!!!
    Success rate is 100 percent (5/5), round-trip min/avg/max = 5/9/14 ms

И даже с компьютера 172.16.17.26 связь есть:  

![](http://img-fotki.yandex.ru/get/5608/83739833.14/0_819ee_c767041_XL.jpg)  

Как же так? Ответ, вы не поверите, так же прост — проблемы с маршрутизацией.  

Дело в том, что msk-arbat-gw1 о подсети 172.16.17.0/24 знает, а о 172.16.2.4/30 нет. А именно адрес 172.16.2.6 — адрес ближайшего к адресату интерфейса (или интерфейса, с которого отправляется IP-пакет) подставляет по умолчанию в качестве источника. Об этом забывать не нужно.  

    msk-arbat-gw1(config)#ip route 172.16.2.4 255.255.255.252 172.16.2.2

    spb-ozerki-gw1#ping 172.16.3.1

    Type escape sequence to abort.
    Sending 5, 100-byte ICMP Echos to 172.16.3.1, timeout is 2 seconds:
    !!!!!
    Success rate is 100 percent (5/5), round-trip min/avg/max = 7/62/269 ms

Ещё интересный опыт: а что если адрес на маршрутизаторе на Васильевском острове маршрут в подсеть 172.16.3.0/24 пропишем на Озерки, а не в Москву? Ну чисто для интереса. Что произойдёт в этом случае?  

    spb-vsl-gw1(config)#ip route 172.16.3.0 255.255.255.0 172.16.2.6

В РТ вы этого не увидите, почему-то, но в реальной жизни получится кольцо маршрутизации. Сети 172.16.3.0/24 и 172.16.16.0/21 не будут видеть друг друга:  
пакет идущий с spb-ozerki-gw1 в сеть 172.16.3.0 попадает в первую очередь на spb-vsl-gw1, где сказано: “172.16.3.0/24 ищите за 172.16.2.6”, а это снова spb-ozerki-gw1, где сказано: “172.16.3.0/24 ищите за 172.16.2.5” и так далее. Пакет будет шастать туда-обратно, пока не истечёт значение в поле TTL.  
Дело в том, что при прохождении каждого маршрутизатора поле TTL в IP-заголовке, изначально имеющее значение 255, уменьшается на 1\. И если вдруг окажется, что это значение равно 0, то пакет _погибает_, точнее маршрутизатор, увидевший это, задропит его. Таким образом обеспечивается стабильность сети — в случае возникновения петли пакеты не будут жить бесконечно, нагружая канал до его полной утилизации. Кстати, в Ethernet такого механизма нет и если получается петля, то коммутатор только и будет делать, что плодить широковещательные запросы, полностью забивая канал — это называется широковещательный шторм (эта проблема решается с помощью специальной технологии\протокола STP- об этом в следующем выпуске).  

В общем, если вы пускаете пинг из сети 172.16.17.0 на адрес 172.16.3.1, то ваш IP-пакет будет путешествовать между двумя маршрутизаторами, пока не истечёт срок его жизни, пройдя при этом по линку между Озерками и Васильевским островом 254 раза. Кстати, следствием из работы этого механизма является то, что не может существовать связная сеть, где между узлами больше 255 маршрутизаторов. Впрочем это и не очень актуальная потребность. Сейчас даже самый долгий трейс занимает пару-тройку десятков хопов.  

### Кемерово. Красная горка

Рассмотрим последний небольшой пример — маршрутизатор на палочке (router on a stick). Название навеяно схемой подключения:  
![](http://img-fotki.yandex.ru/get/6100/83739833.14/0_819f3_c6ed276_XL.jpg)  

Маршрутизатор связан с коммутатором лишь одним кабелем и по разным вланам внутри него передаётся трафик и локальной сети, и внешний. Делается это, как правило, для экономии средств (на маршрутизаторе только один порт и не хочется покупать дополнительную плату). Подключим следующим образом:  
![](http://img-fotki.yandex.ru/get/5607/83739833.14/0_819f7_e121a255_L.jpg)  

Настройка коммутатора уже не должна для вас представлять проблем. На UpLink-интерфейсе настраиваем оговоренный с провайдером 5-й влан транком:  

    Switch(config)#hostname kmr-gorka-sw1
    kmr-gorka-sw1(config)#vlan 5
    kmr-gorka-sw1(config-vlan)#name Moscow
    kmr-gorka-sw1(config)#int fa0/24
    kmr-gorka-sw1(config-if)#description Moscow
    kmr-gorka-sw1(config-if)#switchport mode trunk 
    kmr-gorka-sw1(config-if)#switchport trunk allowed vlan 5

В качестве влана для локальной сети выберем vlan 2 и это ничего, что он уже используется и в Москве и в Питере — если они не пересекаются и вы это можете контролировать, то номера могут совпадать. Тут каждый решает сам: вы можете везде использовать, например, 2-й влан, в качестве влана локальной сети или напротив разработать план, где номера вланов уникальны во всей сети.  

    kmr-gorka-sw1(config)#vlan 2
    kmr-gorka-sw1(config-vlan)#name LAN
    kmr-gorka-sw1(config)#int fa0/1
    kmr-gorka-sw1(config-if)#description syn_generalnogo
    kmr-gorka-sw1(config-if)#switchport mode access 
    kmr-gorka-sw1(config-if)#switchport access vlan 2

Транк в сторону маршрутизатора, где 5-ым вланом будут тегироваться кадры внешнего трафика, а 2-м — локального.  

    kmr-gorka-sw1(config)#int fa0/23
    kmr-gorka-sw1(config-if)#description kmr-gorka-gw1
    kmr-gorka-sw1(config-if)#switchport mode trunk 
    kmr-gorka-sw1(config-if)#switchport trunk allowed vlan 2,5

Настройка маршрутизатора:  

    Router(config)#hostname kmr-gorka-gw1
    kmr-gorka-gw1(config)#int fa0/0.5
    kmr-gorka-gw1(config-subif)#description Moscow
    kmr-gorka-gw1(config-subif)#encapsulation dot1Q 5
    kmr-gorka-gw1(config-subif)#ip address 172.16.2.18 255.255.255.252
    kmr-gorka-gw1(config)#int fa0/0
    kmr-gorka-gw1(config-if)#no sh
    kmr-gorka-gw1(config)#int fa0/0.2
    kmr-gorka-gw1(config-subif)#description LAN
    kmr-gorka-gw1(config-subif)#encapsulation dot1Q 2
    kmr-gorka-gw1(config-subif)#ip address 172.16.24.1 255.255.255.0

Полагаем, что маршрутизацию здесь между Москвой и Кемерово вы теперь сможете настроить самостоятельно.  

# Дополнительно

В случае, если с маршрутизацией не всё в порядке для траблшутинга вам понадобятся две команды:  
traceroute и show ip route.  
У первой бывает полезным, как вы видели, задать адрес источника. А последнюю можно применять с параметрами, например:  

    msk-arbat-gw1#sh ip route 172.16.17.0
    Routing entry for 172.16.16.0/21
    Known via "static", distance 1, metric 0
    Routing Descriptor Blocks:
    * 172.16.2.2
    Route metric is 0, traffic share count is 1

Несмотря на то, что в таблице маршрутизации нет отдельной записи для подсети 172.16.17.0, маршрутизатор покажет вам, какой следующий хоп.  

И ещё хотелось бы повторить самые важные вещи:  

*   Когда блок данных попадает на маршрутизатор, заголовок Ethernet полностью отбрасывается и при отправке формируется совершенно новый кадр. Но IP-пакет остаётся неизменным
*   Каждый маршрутизатор в случае статической маршрутизации принимает решение о судьбе пакета исключительно самостоятельно и не знает ничего о чужих таблицах
*   Поиск в таблице идёт НЕ до первой попавшейся подходящей записи, а до тех пор, пока не будет найдено самое точное соответствие (самая узкая маска). Например, если у вас таблица маршрутизации выглядит так:  

        172.16.0.0/16 is variably subnetted, 6 subnets, 3 masks
        S 172.16.0.0/16 [1/0] via 172.16.2.22
        C 172.16.2.20/30 is directly connected, FastEthernet0/0
        C 172.16.2.24/30 is directly connected, FastEthernet0/0.2
        C 172.16.2.28/30 is directly connected, FastEthernet0/0.3
        S 172.16.10.0/24 [1/0] via 172.16.2.26
        S 172.16.10.4/30 [1/0] via 172.16.2.30

    И вы передаёте данные на 172.16.10.5, то он не пойдёт ни по маршруту через 172.16.2.22 ни через 172.16.2.26, а выберет самую узкую маску (самую длинную) /30 через 172.16.2.30
*   Если IP-адресу получателя не будет соответствовать ни одна запись в таблице маршрутизации и не настроен маршрут по умолчанию (шлюз последней надежды), пакет будет просто отброшен

На этом первое знакомство с маршрутизацией можно закончить. Нам кажется, что читатель сам видит, сколько сложностей поджидает его здесь, может предположить, какой объём работы предстоит ему, если сеть разрастётся до нескольких десятков маршрутизаторов. Но надо сказать, что в современном мире статическая маршрутизация, не то чтобы не используется, конечно, ей есть место, но в подавляющем большинстве сетей, крупнее районного пионер-нета внедрены протоколы динамической маршрутизации. Среди них OSPF, EIGRP, IS-IS, RIP, которым мы посвятим отдельный выпуск и, скорее всего, не один. Но настройка статической маршрутизации в значительной степени поможет вашему общему пониманию маршрутизации. В качестве самостоятельного задания попробуйте настроить маршрутизацию между Москвой и Кемерово и ответить на вопрос, почему не пингуются устройства из сети управления.  
![](http://img-fotki.yandex.ru/get/6201/83739833.14/0_81a6c_8710471e_XL.jpg)  

# Материалы выпуска

[Новый IP-план, планы коммутации по каждой точке и регламент](https://docs.google.com/spreadsheet/ccc?key=0AooexOHebRpTdHgxWTZtbWNrT3JkR3NmX2pBZ25xTGc)  
[Файл РТ с лабораторной](https://www.dropbox.com/s/tomegug5inuhuhy/Lift-me-Up_v3.pkt?dl=0)  
[Конфигурация устройств](https://docs.google.com/document/d/1fzWkfA8cQiDocK6yBKTRVtpwxyuM330L5PR9lB8wnZ0/edit)  

Приносим извинения за гигантские простыни, видео тоже с каждым разом становится всё длиннее и невыносимее. Постараемся в следующий раз быть более компактными.  

## Авторы

Марат eucariot  
Максим aka gluck.
